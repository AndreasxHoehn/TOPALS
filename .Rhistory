-7.5845, -7.7219, -7.8628, -7.9771, -8.041, -8.0568, -8.0329,
-7.9779, -7.9005, -7.8088, -7.7101, -7.6113, -7.5195, -7.4415,
-7.3823, -7.3393, -7.308, -7.2837, -7.2619, -7.238, -7.2082,
-7.1712, -7.1264, -7.0735, -7.0118, -6.9414, -6.8648, -6.7849,
-6.7047, -6.6272, -6.5544, -6.4845, -6.4147, -6.3423, -6.2645,
-6.1791, -6.0872, -5.9904, -5.8903, -5.7887, -5.6869, -5.586,
-5.4866, -5.3895, -5.2953, -5.2049, -5.1186, -5.0347, -4.9513,
-4.8664, -4.778, -4.6847, -4.5877, -4.4887, -4.3895, -4.2918,
-4.1969, -4.1041, -4.0122, -3.9199, -3.8261, -3.7296, -3.6303,
-3.5278, -3.4221, -3.3129, -3.2004, -3.0861, -2.9716, -2.8589,
-2.7497, -2.6458, -2.5482, -2.4556, -2.3659, -2.2771, -2.187,
-2.0942, -1.9991, -1.9028, -1.8062, -1.7105, -1.6164, -1.5242,
-1.434, -1.3458, -1.2596, -1.1758, -1.0958, -1.0212, -0.9535,
-0.8944, -0.8454)
## single-year log mortality rates from HMD
## these are the targets for TOPALS estimation
ITA_HMD_logmx =
c(-4.3852, -7.1185, -7.6009, -7.7517, -8.1117, -8.1456, -8.1456,
-8.1456, -8.294, -8.2171, -8.4684, -8.294, -8.3349, -8.1456,
-8.0789, -7.9866, -7.9866, -8.0164, -7.902, -7.824, -7.7753,
-7.7753, -7.7753, -7.7753, -7.8753, -7.7063, -7.7063, -7.6628,
-7.6417, -7.8753, -7.4876, -7.4354, -7.2644, -7.3233, -7.3385,
-7.2644, -7.0021, -6.959, -6.959, -6.7855, -6.8216, -6.5713,
-6.5225, -6.4956, -6.3539, -6.2712, -6.2196, -6.0035, -5.9835,
-5.8569, -5.7992, -5.7169, -5.6694, -5.5315, -5.433, -5.3247,
-5.2514, -5.1814, -5.0625, -4.9533, -4.8783, -4.7915, -4.6767,
-4.5923, -4.4945, -4.3836, -4.2992, -4.1825, -4.0513, -3.9409,
-3.8135, -3.6913, -3.5332, -3.4455, -3.2966, -3.2069, -3.0614,
-2.9677, -2.8466, -2.7201, -2.5974, -2.4617, -2.3462, -2.2249,
-2.1253, -1.9713, -1.8905, -1.7861, -1.6842, -1.5945, -1.4583,
-1.3792, -1.297, -1.2087, -1.1393, -1.0245, -0.9444, -0.8681,
-0.7958, -0.7276)
show_topals = function(fit, include_sd=FALSE, hue='red') {
df_grouped = data.frame(
L = head( fit$age_group_bounds, -1),
U = tail( fit$age_group_bounds, -1),
N = fit$N,
D = fit$D
) %>%
mutate(logmx_obs = log(D/N))
df_single  = data.frame(
age=  seq(fit$std) - .50,  # 0.5, 1.5, ...
std = fit$std,
logmx_true = ITA_HMD_logmx,
logmx_fit  = fit$logm
)
this_plot =
ggplot(data = df_single, aes(x=age,y=logmx_true)) +
geom_line(aes(x=age,y=std), color='black', lwd=0.5) +
geom_line(aes(x=age,y=logmx_fit), color=hue, lwd=3, alpha=.40) +
geom_segment(data=df_grouped,aes(x=L,xend=U,
y=logmx_obs,
yend=logmx_obs),
color=hue,lwd=1.5, alpha=.90) +
geom_point(size=0.60) +
labs(x='Age',y='Log Mortality Rate',
title='Italy Females 1980',
subtitle = paste(sum(fit$D),'deaths to',round(sum(fit$N)),'women')) +
scale_x_continuous(breaks=c(0,1,seq(5,100,5)),minor_breaks = NULL) +
scale_y_continuous(limits=c(-10,0),breaks=seq(-10,0,2),minor_breaks = NULL) +
theme_bw()
if (include_sd) {
sd = sqrt( diag( fit$B %*% fit$covar %*% t(fit$B)))
factor = qnorm(.90)
df_errors = data.frame(age = seq(fit$std) - 0.50,
L = fit$logm - factor * sd,
H = fit$logm + factor * sd)
this_plot = this_plot +
geom_segment(aes(x=age, xend=age, y=L, yend=H), lwd=0.5, color=hue)
}
print(this_plot)
} # show_topals
fit = TOPALS_fit(N,D,std,
age_group_bounds = boundaries,
details=TRUE)
show_topals(fit)
sd_lambda = sqrt( diag ( fit$B %*% fit$covar %*% t(fit$B) ) )
plot(0:99, sd_lambda, type='h', xlab='age', ylim=range(0,sd_lambda),
main='SD of estimated log mortality')
show_topals(fit, include_sd = TRUE, hue='red')
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(splines)
# include the fitting function
source('TOPALS_fit.R', echo=TRUE)
## Italian female 1980 HMD data for age groups
boundaries = c(0,1,seq(5,85,5))  # last group is [80,85)
N = c(312106.85, 1423566.3, 2105814.63, 2249555.41, 2230885.74, 1983157.8,
1874479.58, 1989351.99, 1772133.73, 1896866.51, 1836597.36, 1834496.64,
1811178.38, 1192763.85, 1498384.03, 1223810.9, 863725.92, 537720.77)
D = c(3889, 716, 587, 589, 791, 816, 832, 1257, 1651, 2721, 4310,
6636, 10536, 11043, 23312, 34945, 44537, 50392)
names(N) = names(D) = head(boundaries,-1)
## standard schedule is (very arbitrarily!) the 1959 period
## schedule for Canadian females at ages 0,1,...,99
## these are the log mortality rates
std = c(-3.8933, -5.7776, -6.8474, -7.3298, -7.4519, -7.4408, -7.4807,
-7.5845, -7.7219, -7.8628, -7.9771, -8.041, -8.0568, -8.0329,
-7.9779, -7.9005, -7.8088, -7.7101, -7.6113, -7.5195, -7.4415,
-7.3823, -7.3393, -7.308, -7.2837, -7.2619, -7.238, -7.2082,
-7.1712, -7.1264, -7.0735, -7.0118, -6.9414, -6.8648, -6.7849,
-6.7047, -6.6272, -6.5544, -6.4845, -6.4147, -6.3423, -6.2645,
-6.1791, -6.0872, -5.9904, -5.8903, -5.7887, -5.6869, -5.586,
-5.4866, -5.3895, -5.2953, -5.2049, -5.1186, -5.0347, -4.9513,
-4.8664, -4.778, -4.6847, -4.5877, -4.4887, -4.3895, -4.2918,
-4.1969, -4.1041, -4.0122, -3.9199, -3.8261, -3.7296, -3.6303,
-3.5278, -3.4221, -3.3129, -3.2004, -3.0861, -2.9716, -2.8589,
-2.7497, -2.6458, -2.5482, -2.4556, -2.3659, -2.2771, -2.187,
-2.0942, -1.9991, -1.9028, -1.8062, -1.7105, -1.6164, -1.5242,
-1.434, -1.3458, -1.2596, -1.1758, -1.0958, -1.0212, -0.9535,
-0.8944, -0.8454)
## single-year log mortality rates from HMD
## these are the targets for TOPALS estimation
ITA_HMD_logmx =
c(-4.3852, -7.1185, -7.6009, -7.7517, -8.1117, -8.1456, -8.1456,
-8.1456, -8.294, -8.2171, -8.4684, -8.294, -8.3349, -8.1456,
-8.0789, -7.9866, -7.9866, -8.0164, -7.902, -7.824, -7.7753,
-7.7753, -7.7753, -7.7753, -7.8753, -7.7063, -7.7063, -7.6628,
-7.6417, -7.8753, -7.4876, -7.4354, -7.2644, -7.3233, -7.3385,
-7.2644, -7.0021, -6.959, -6.959, -6.7855, -6.8216, -6.5713,
-6.5225, -6.4956, -6.3539, -6.2712, -6.2196, -6.0035, -5.9835,
-5.8569, -5.7992, -5.7169, -5.6694, -5.5315, -5.433, -5.3247,
-5.2514, -5.1814, -5.0625, -4.9533, -4.8783, -4.7915, -4.6767,
-4.5923, -4.4945, -4.3836, -4.2992, -4.1825, -4.0513, -3.9409,
-3.8135, -3.6913, -3.5332, -3.4455, -3.2966, -3.2069, -3.0614,
-2.9677, -2.8466, -2.7201, -2.5974, -2.4617, -2.3462, -2.2249,
-2.1253, -1.9713, -1.8905, -1.7861, -1.6842, -1.5945, -1.4583,
-1.3792, -1.297, -1.2087, -1.1393, -1.0245, -0.9444, -0.8681,
-0.7958, -0.7276)
show_topals = function(fit, include_sd=FALSE, hue='red') {
df_grouped = data.frame(
L = head( fit$age_group_bounds, -1),
U = tail( fit$age_group_bounds, -1),
N = fit$N,
D = fit$D
) %>%
mutate(logmx_obs = log(D/N))
df_single  = data.frame(
age=  seq(fit$std) - .50,  # 0.5, 1.5, ...
std = fit$std,
logmx_true = ITA_HMD_logmx,
logmx_fit  = fit$logm
)
this_plot =
ggplot(data = df_single, aes(x=age,y=logmx_true)) +
geom_line(aes(x=age,y=std), color='black', lwd=0.5) +
geom_line(aes(x=age,y=logmx_fit), color=hue, lwd=3, alpha=.40) +
geom_segment(data=df_grouped,aes(x=L,xend=U,
y=logmx_obs,
yend=logmx_obs),
color=hue,lwd=1.5, alpha=.90) +
geom_point(size=0.60) +
labs(x='Age',y='Log Mortality Rate',
title='Italy Females 1980',
subtitle = paste(sum(fit$D),'deaths to',round(sum(fit$N)),'women')) +
scale_x_continuous(breaks=c(0,1,seq(5,100,5)),minor_breaks = NULL) +
scale_y_continuous(limits=c(-10,0),breaks=seq(-10,0,2),minor_breaks = NULL) +
theme_bw()
if (include_sd) {
sd = sqrt( diag( fit$B %*% fit$covar %*% t(fit$B)))
factor = qnorm(.90)
df_errors = data.frame(age = seq(fit$std) - 0.50,
L = fit$logm - factor * sd,
H = fit$logm + factor * sd)
this_plot = this_plot +
geom_segment(data=df_errors,
aes(x=age, xend=age, y=L, yend=H), lwd=0.5, color=hue)
}
print(this_plot)
} # show_topals
fit = TOPALS_fit(N,D,std,
age_group_bounds = boundaries,
details=TRUE)
show_topals(fit)
sd_lambda = sqrt( diag ( fit$B %*% fit$covar %*% t(fit$B) ) )
plot(0:99, sd_lambda, type='h', xlab='age', ylim=range(0,sd_lambda),
main='SD of estimated log mortality')
show_topals(fit, include_sd = TRUE, hue='red')
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(splines)
# include the fitting function
source('TOPALS_fit.R', echo=TRUE)
## Italian female 1980 HMD data for age groups
boundaries = c(0,1,seq(5,85,5))  # last group is [80,85)
N = c(312106.85, 1423566.3, 2105814.63, 2249555.41, 2230885.74, 1983157.8,
1874479.58, 1989351.99, 1772133.73, 1896866.51, 1836597.36, 1834496.64,
1811178.38, 1192763.85, 1498384.03, 1223810.9, 863725.92, 537720.77)
D = c(3889, 716, 587, 589, 791, 816, 832, 1257, 1651, 2721, 4310,
6636, 10536, 11043, 23312, 34945, 44537, 50392)
names(N) = names(D) = head(boundaries,-1)
## standard schedule is (very arbitrarily!) the 1959 period
## schedule for Canadian females at ages 0,1,...,99
## these are the log mortality rates
std = c(-3.8933, -5.7776, -6.8474, -7.3298, -7.4519, -7.4408, -7.4807,
-7.5845, -7.7219, -7.8628, -7.9771, -8.041, -8.0568, -8.0329,
-7.9779, -7.9005, -7.8088, -7.7101, -7.6113, -7.5195, -7.4415,
-7.3823, -7.3393, -7.308, -7.2837, -7.2619, -7.238, -7.2082,
-7.1712, -7.1264, -7.0735, -7.0118, -6.9414, -6.8648, -6.7849,
-6.7047, -6.6272, -6.5544, -6.4845, -6.4147, -6.3423, -6.2645,
-6.1791, -6.0872, -5.9904, -5.8903, -5.7887, -5.6869, -5.586,
-5.4866, -5.3895, -5.2953, -5.2049, -5.1186, -5.0347, -4.9513,
-4.8664, -4.778, -4.6847, -4.5877, -4.4887, -4.3895, -4.2918,
-4.1969, -4.1041, -4.0122, -3.9199, -3.8261, -3.7296, -3.6303,
-3.5278, -3.4221, -3.3129, -3.2004, -3.0861, -2.9716, -2.8589,
-2.7497, -2.6458, -2.5482, -2.4556, -2.3659, -2.2771, -2.187,
-2.0942, -1.9991, -1.9028, -1.8062, -1.7105, -1.6164, -1.5242,
-1.434, -1.3458, -1.2596, -1.1758, -1.0958, -1.0212, -0.9535,
-0.8944, -0.8454)
## single-year log mortality rates from HMD
## these are the targets for TOPALS estimation
ITA_HMD_logmx =
c(-4.3852, -7.1185, -7.6009, -7.7517, -8.1117, -8.1456, -8.1456,
-8.1456, -8.294, -8.2171, -8.4684, -8.294, -8.3349, -8.1456,
-8.0789, -7.9866, -7.9866, -8.0164, -7.902, -7.824, -7.7753,
-7.7753, -7.7753, -7.7753, -7.8753, -7.7063, -7.7063, -7.6628,
-7.6417, -7.8753, -7.4876, -7.4354, -7.2644, -7.3233, -7.3385,
-7.2644, -7.0021, -6.959, -6.959, -6.7855, -6.8216, -6.5713,
-6.5225, -6.4956, -6.3539, -6.2712, -6.2196, -6.0035, -5.9835,
-5.8569, -5.7992, -5.7169, -5.6694, -5.5315, -5.433, -5.3247,
-5.2514, -5.1814, -5.0625, -4.9533, -4.8783, -4.7915, -4.6767,
-4.5923, -4.4945, -4.3836, -4.2992, -4.1825, -4.0513, -3.9409,
-3.8135, -3.6913, -3.5332, -3.4455, -3.2966, -3.2069, -3.0614,
-2.9677, -2.8466, -2.7201, -2.5974, -2.4617, -2.3462, -2.2249,
-2.1253, -1.9713, -1.8905, -1.7861, -1.6842, -1.5945, -1.4583,
-1.3792, -1.297, -1.2087, -1.1393, -1.0245, -0.9444, -0.8681,
-0.7958, -0.7276)
show_topals = function(fit, include_sd=FALSE, hue='red') {
df_grouped = data.frame(
L = head( fit$age_group_bounds, -1),
U = tail( fit$age_group_bounds, -1),
N = fit$N,
D = fit$D
) %>%
mutate(logmx_obs = log(D/N))
df_single  = data.frame(
age=  seq(fit$std) - .50,  # 0.5, 1.5, ...
std = fit$std,
logmx_true = ITA_HMD_logmx,
logmx_fit  = fit$logm
)
this_plot =
ggplot(data = df_single, aes(x=age,y=logmx_true)) +
geom_line(aes(x=age,y=std), color='black', lwd=0.5) +
geom_line(aes(x=age,y=logmx_fit), color=hue, lwd=3, alpha=.40) +
geom_segment(data=df_grouped,aes(x=L,xend=U,
y=logmx_obs,
yend=logmx_obs),
color=hue,lwd=1.5, alpha=.90) +
geom_point(size=0.60) +
labs(x='Age',y='Log Mortality Rate',
title='Italy Females 1980',
subtitle = paste(sum(fit$D),'deaths to',round(sum(fit$N)),'women')) +
scale_x_continuous(breaks=c(0,1,seq(5,100,5)),minor_breaks = NULL) +
scale_y_continuous(limits=c(-10,0),breaks=seq(-10,0,2),minor_breaks = NULL) +
theme_bw()
if (include_sd) {
sd = sqrt( diag( fit$B %*% fit$covar %*% t(fit$B)))
factor = qnorm(.90)
df_errors = data.frame(age = seq(fit$std) - 0.50,
L = fit$logm - factor * sd,
H = fit$logm + factor * sd)
this_plot = this_plot +
geom_segment(data=df_errors,
aes(x=age, xend=age, y=L, yend=H), lwd=0.5, color=hue,
inherit.aes = FALSE)
}
print(this_plot)
} # show_topals
fit = TOPALS_fit(N,D,std,
age_group_bounds = boundaries,
details=TRUE)
show_topals(fit)
sd_lambda = sqrt( diag ( fit$B %*% fit$covar %*% t(fit$B) ) )
plot(0:99, sd_lambda, type='h', xlab='age', ylim=range(0,sd_lambda),
main='SD of estimated log mortality')
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(splines)
# include the fitting function
source('TOPALS_fit.R', echo=TRUE)
## Italian female 1980 HMD data for age groups
boundaries = c(0,1,seq(5,85,5))  # last group is [80,85)
N = c(312106.85, 1423566.3, 2105814.63, 2249555.41, 2230885.74, 1983157.8,
1874479.58, 1989351.99, 1772133.73, 1896866.51, 1836597.36, 1834496.64,
1811178.38, 1192763.85, 1498384.03, 1223810.9, 863725.92, 537720.77)
D = c(3889, 716, 587, 589, 791, 816, 832, 1257, 1651, 2721, 4310,
6636, 10536, 11043, 23312, 34945, 44537, 50392)
names(N) = names(D) = head(boundaries,-1)
## standard schedule is (very arbitrarily!) the 1959 period
## schedule for Canadian females at ages 0,1,...,99
## these are the log mortality rates
std = c(-3.8933, -5.7776, -6.8474, -7.3298, -7.4519, -7.4408, -7.4807,
-7.5845, -7.7219, -7.8628, -7.9771, -8.041, -8.0568, -8.0329,
-7.9779, -7.9005, -7.8088, -7.7101, -7.6113, -7.5195, -7.4415,
-7.3823, -7.3393, -7.308, -7.2837, -7.2619, -7.238, -7.2082,
-7.1712, -7.1264, -7.0735, -7.0118, -6.9414, -6.8648, -6.7849,
-6.7047, -6.6272, -6.5544, -6.4845, -6.4147, -6.3423, -6.2645,
-6.1791, -6.0872, -5.9904, -5.8903, -5.7887, -5.6869, -5.586,
-5.4866, -5.3895, -5.2953, -5.2049, -5.1186, -5.0347, -4.9513,
-4.8664, -4.778, -4.6847, -4.5877, -4.4887, -4.3895, -4.2918,
-4.1969, -4.1041, -4.0122, -3.9199, -3.8261, -3.7296, -3.6303,
-3.5278, -3.4221, -3.3129, -3.2004, -3.0861, -2.9716, -2.8589,
-2.7497, -2.6458, -2.5482, -2.4556, -2.3659, -2.2771, -2.187,
-2.0942, -1.9991, -1.9028, -1.8062, -1.7105, -1.6164, -1.5242,
-1.434, -1.3458, -1.2596, -1.1758, -1.0958, -1.0212, -0.9535,
-0.8944, -0.8454)
## single-year log mortality rates from HMD
## these are the targets for TOPALS estimation
ITA_HMD_logmx =
c(-4.3852, -7.1185, -7.6009, -7.7517, -8.1117, -8.1456, -8.1456,
-8.1456, -8.294, -8.2171, -8.4684, -8.294, -8.3349, -8.1456,
-8.0789, -7.9866, -7.9866, -8.0164, -7.902, -7.824, -7.7753,
-7.7753, -7.7753, -7.7753, -7.8753, -7.7063, -7.7063, -7.6628,
-7.6417, -7.8753, -7.4876, -7.4354, -7.2644, -7.3233, -7.3385,
-7.2644, -7.0021, -6.959, -6.959, -6.7855, -6.8216, -6.5713,
-6.5225, -6.4956, -6.3539, -6.2712, -6.2196, -6.0035, -5.9835,
-5.8569, -5.7992, -5.7169, -5.6694, -5.5315, -5.433, -5.3247,
-5.2514, -5.1814, -5.0625, -4.9533, -4.8783, -4.7915, -4.6767,
-4.5923, -4.4945, -4.3836, -4.2992, -4.1825, -4.0513, -3.9409,
-3.8135, -3.6913, -3.5332, -3.4455, -3.2966, -3.2069, -3.0614,
-2.9677, -2.8466, -2.7201, -2.5974, -2.4617, -2.3462, -2.2249,
-2.1253, -1.9713, -1.8905, -1.7861, -1.6842, -1.5945, -1.4583,
-1.3792, -1.297, -1.2087, -1.1393, -1.0245, -0.9444, -0.8681,
-0.7958, -0.7276)
show_topals = function(fit, include_sd=FALSE, hue='red') {
df_grouped = data.frame(
L = head( fit$age_group_bounds, -1),
U = tail( fit$age_group_bounds, -1),
N = fit$N,
D = fit$D
) %>%
mutate(logmx_obs = log(D/N))
df_single  = data.frame(
age=  seq(fit$std) - .50,  # 0.5, 1.5, ...
std = fit$std,
logmx_true = ITA_HMD_logmx,
logmx_fit  = fit$logm
)
this_plot =
ggplot(data = df_single, aes(x=age,y=logmx_true)) +
geom_line(aes(x=age,y=std), color='black', lwd=0.5) +
geom_line(aes(x=age,y=logmx_fit), color=hue, lwd=3, alpha=.40) +
geom_segment(data=df_grouped,aes(x=L,xend=U,
y=logmx_obs,
yend=logmx_obs),
color=hue,lwd=1.5, alpha=.90) +
geom_point(size=0.60) +
labs(x='Age',y='Log Mortality Rate',
title='Italy Females 1980',
subtitle = paste(sum(fit$D),'deaths to',round(sum(fit$N)),'women')) +
scale_x_continuous(breaks=c(0,1,seq(5,100,5)),minor_breaks = NULL) +
scale_y_continuous(limits=c(-10,0),breaks=seq(-10,0,2),minor_breaks = NULL) +
theme_bw()
if (include_sd) {
sd = sqrt( diag( fit$B %*% fit$covar %*% t(fit$B)))
factor = qnorm(.90)
df_errors = data.frame(age = seq(fit$std) - 0.50,
L = fit$logm - factor * sd,
H = fit$logm + factor * sd)
this_plot = this_plot +
geom_segment(data=df_errors,
aes(x=age, xend=age, y=L, yend=H), lwd=0.5, color=hue,
inherit.aes = FALSE)
}
print(this_plot)
} # show_topals
fit = TOPALS_fit(N,D,std,
age_group_bounds = boundaries,
details=TRUE)
show_topals(fit)
sd_lambda = sqrt( diag ( fit$B %*% fit$covar %*% t(fit$B) ) )
plot(0:99, sd_lambda, type='h', xlab='age', ylim=range(0,sd_lambda),
main='SD of estimated log mortality')
show_topals(fit, include_sd = TRUE, hue='red')
show_topals(fit, emphasize_sd = TRUE, hue='red')
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(splines)
# include the fitting function
source('TOPALS_fit.R', echo=TRUE)
## Italian female 1980 HMD data for age groups
boundaries = c(0,1,seq(5,85,5))  # last group is [80,85)
N = c(312106.85, 1423566.3, 2105814.63, 2249555.41, 2230885.74, 1983157.8,
1874479.58, 1989351.99, 1772133.73, 1896866.51, 1836597.36, 1834496.64,
1811178.38, 1192763.85, 1498384.03, 1223810.9, 863725.92, 537720.77)
D = c(3889, 716, 587, 589, 791, 816, 832, 1257, 1651, 2721, 4310,
6636, 10536, 11043, 23312, 34945, 44537, 50392)
names(N) = names(D) = head(boundaries,-1)
## standard schedule is (very arbitrarily!) the 1959 period
## schedule for Canadian females at ages 0,1,...,99
## these are the log mortality rates
std = c(-3.8933, -5.7776, -6.8474, -7.3298, -7.4519, -7.4408, -7.4807,
-7.5845, -7.7219, -7.8628, -7.9771, -8.041, -8.0568, -8.0329,
-7.9779, -7.9005, -7.8088, -7.7101, -7.6113, -7.5195, -7.4415,
-7.3823, -7.3393, -7.308, -7.2837, -7.2619, -7.238, -7.2082,
-7.1712, -7.1264, -7.0735, -7.0118, -6.9414, -6.8648, -6.7849,
-6.7047, -6.6272, -6.5544, -6.4845, -6.4147, -6.3423, -6.2645,
-6.1791, -6.0872, -5.9904, -5.8903, -5.7887, -5.6869, -5.586,
-5.4866, -5.3895, -5.2953, -5.2049, -5.1186, -5.0347, -4.9513,
-4.8664, -4.778, -4.6847, -4.5877, -4.4887, -4.3895, -4.2918,
-4.1969, -4.1041, -4.0122, -3.9199, -3.8261, -3.7296, -3.6303,
-3.5278, -3.4221, -3.3129, -3.2004, -3.0861, -2.9716, -2.8589,
-2.7497, -2.6458, -2.5482, -2.4556, -2.3659, -2.2771, -2.187,
-2.0942, -1.9991, -1.9028, -1.8062, -1.7105, -1.6164, -1.5242,
-1.434, -1.3458, -1.2596, -1.1758, -1.0958, -1.0212, -0.9535,
-0.8944, -0.8454)
## single-year log mortality rates from HMD
## these are the targets for TOPALS estimation
ITA_HMD_logmx =
c(-4.3852, -7.1185, -7.6009, -7.7517, -8.1117, -8.1456, -8.1456,
-8.1456, -8.294, -8.2171, -8.4684, -8.294, -8.3349, -8.1456,
-8.0789, -7.9866, -7.9866, -8.0164, -7.902, -7.824, -7.7753,
-7.7753, -7.7753, -7.7753, -7.8753, -7.7063, -7.7063, -7.6628,
-7.6417, -7.8753, -7.4876, -7.4354, -7.2644, -7.3233, -7.3385,
-7.2644, -7.0021, -6.959, -6.959, -6.7855, -6.8216, -6.5713,
-6.5225, -6.4956, -6.3539, -6.2712, -6.2196, -6.0035, -5.9835,
-5.8569, -5.7992, -5.7169, -5.6694, -5.5315, -5.433, -5.3247,
-5.2514, -5.1814, -5.0625, -4.9533, -4.8783, -4.7915, -4.6767,
-4.5923, -4.4945, -4.3836, -4.2992, -4.1825, -4.0513, -3.9409,
-3.8135, -3.6913, -3.5332, -3.4455, -3.2966, -3.2069, -3.0614,
-2.9677, -2.8466, -2.7201, -2.5974, -2.4617, -2.3462, -2.2249,
-2.1253, -1.9713, -1.8905, -1.7861, -1.6842, -1.5945, -1.4583,
-1.3792, -1.297, -1.2087, -1.1393, -1.0245, -0.9444, -0.8681,
-0.7958, -0.7276)
show_topals = function(fit, emphasize_sd=FALSE, hue='red') {
df_grouped = data.frame(
L = head( fit$age_group_bounds, -1),
U = tail( fit$age_group_bounds, -1),
N = fit$N,
D = fit$D
) %>%
mutate(logmx_obs = log(D/N))
df_single  = data.frame(
age=  seq(fit$std) - .50,  # 0.5, 1.5, ...
std = fit$std,
logmx_true = ITA_HMD_logmx,
logmx_fit  = fit$logm
)
this_plot =
ggplot(data = df_single, aes(x=age,y=logmx_true)) +
labs(x='Age',y='Log Mortality Rate',
title='Italy Females 1980',
subtitle = paste(sum(fit$D),'deaths to',round(sum(fit$N)),'women')) +
scale_x_continuous(breaks=c(0,1,seq(5,100,5)),minor_breaks = NULL) +
scale_y_continuous(limits=c(-10,0),breaks=seq(-10,0,2),minor_breaks = NULL) +
theme_bw()
if (!emphasize_sd) {
this_plot = this_plot +
geom_line(aes(x=age,y=std), color='black', lwd=0.5) +
geom_line(aes(x=age,y=logmx_fit), color=hue, lwd=3, alpha=.40) +
geom_segment(data=df_grouped,aes(x=L,xend=U,
y=logmx_obs,
yend=logmx_obs),
color=hue,lwd=1.5, alpha=.90) +
geom_point(size=0.60, alpha=.70)
} else {
sd = sqrt( diag( fit$B %*% fit$covar %*% t(fit$B)))
factor = qnorm(.90)
df_errors = data.frame(age = seq(fit$std) - 0.50,
L = fit$logm - factor * sd,
H = fit$logm + factor * sd)
this_plot = this_plot +
geom_segment(data=df_errors,
aes(x=age, xend=age, y=L, yend=H), lwd=0.5, color=hue,
inherit.aes = FALSE)
}
print(this_plot)
} # show_topals
fit = TOPALS_fit(N,D,std,
age_group_bounds = boundaries,
details=TRUE)
show_topals(fit)
sd_lambda = sqrt( diag ( fit$B %*% fit$covar %*% t(fit$B) ) )
plot(0:99, sd_lambda, type='h', xlab='age', ylim=range(0,sd_lambda),
main='SD of estimated log mortality')
show_topals(fit, emphasize_sd = TRUE, hue='red')
C = t(chol( fit$B %*% fit$covar %*% t(fit$B) ))
fit$B %*% fit$covar %*% t(fit$B)
C = t(chol( fit$covar) )
lambda_sim = C %*% matrix(rnorm(10*7), nrow=7)
matplot(0:99, lambda_sim, type='l')
lambda_sim = fit$std + fit$B %*% C %*% matrix(rnorm(10*7), nrow=7)
matplot(0:99, lambda_sim, type='l')
matplot(0:99, lambda_sim, type='l', main='10 simulated draws')
# generate 1000 draws from the log mortality schedule
lambda_sim = fit$std + fit$B %*% C %*% matrix(rnorm(1000*7), nrow=7)
# plot the first 10 draws
matplot(0:99, lambda_sim[,1:10], type='l', main='10 simulated draws')
e0(lambda_sim[,1])
e0 = function(logmx) {
x = c(seq(logmx)-1, length(logmx))   # 0,1,...,start open interv
mx = exp(c(logmx, tail(logmx,1)))  # add open interval
nx = c( rep(1, length(logmx)), Inf)
px = exp(-mx * nx)
lx = c(1,cumprod( head(px,-1)))  # for 0,1,...,start open interv
ax = 1/mx - 1*(px/(1-px))
ax[1] = 0.1
dx = -diff(c(lx,0))
Lx = lx*px + dx*ax
return( sum(Lx))
}
e0(lambda_sim[,1])
plot(density( apply(lambda_sim,2, e0), adj=1.5))
e0(ITA_HMD_logmx)
e0(lambda_sim[,2])
e0(lambda_sim[,3])
e0(lambda_sim[,4])
e0(ITA_HMD_logmx)
fit$logm - ITA_HMD_logmx
plot( 0:99, fit$logm - ITA_HMD_logmx, type='h')
plot( 0:99, exp(fit$logm) - exp(ITA_HMD_logmx), type='h')
