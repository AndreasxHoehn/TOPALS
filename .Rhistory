filter(Year==1959, Age<100) %>%
select(age=Age,mx=mx) %>%
mutate(logmx = log(mx))
std = smooth.spline(CAN$logmx, nknots=20)$y
save(rate1, rate5, N5, D5, ITA, std, file='ITA.Rdata')
} else {
load('ITA.Rdata')
}
##################################################
age = 0:99
knot_positions = c(0,1,10,20,40,70)
## B is an Ax7 matrix. Each column is a linear B-spline basis function
B      = bs( age, knots=knot_positions, degree=1 )
K = ncol(B)
D1 = diff( diag(K), diff=1)
P  = 2 * crossprod(D1)
####################################
L = c(0,1,seq(5,95,5))
W = matrix(0, nrow=length(L), ncol=length(age),
dimnames=list(L,age))
W['0','0'] = 1
W['1',2:5] = 0.25
for (i in 3:21) W[i, 5*(i-2)+1:5] = 0.2
bigN = ITA$expos
bigD = ITA$deaths
bigN
dput(bigN)
age
L
knitr::opts_chunk$set(echo = TRUE)
L = c(0,1,seq(5,80,5))
L
N = c(312106.85, 1423566.3, 2105814.63, 2249555.41, 2230885.74, 1983157.8,
1874479.58, 1989351.99, 1772133.73, 1896866.51, 1836597.36, 1834496.64,
1811178.38, 1192763.85, 1498384.03, 1223810.9, 863725.92, 537720.77)
length(L)
length(N)
bigD
dput( head(bigD, -3))
L = c(0,1,seq(5,80,5))
U = c(head(L,-1),90)
U
L
U-L
L = c(0,1,seq(5,80,5))
U = c(tail(L,-1),90)
U
L
L = c(0,1,seq(5,80,5))
U = c(tail(L,-1),85)
U-L
std
std
dput(round(std,4))
L
W = matrix(0, nrow=length(L), ncol=length(age),
dimnames=list(L,age))
W['0','0'] = 1
W['1',2:5] = 0.25
for (i in 3:nrow(W)) W[i, 5*(i-2)+1:5] = 0.2
## weighting matrix W
A = length(age) # number of single-year ages
G = length(L)   # number of age groups
W = matrix(0, nrow=G, ncol=A, dimnames=list(L,age))
W['0','0'] = 1
W['1',2:5] = 0.25
for (i in 3:nrow(W)) W[i, 5*(i-2)+1:5] = 0.2
## weighting matrix W
A = length(age) # number of single-year ages
G = length(L)   # number of age groups
W = matrix(0, nrow=G, ncol=A, dimnames=list(L,age))
W['0','0'] = 1
W['1',2:5] = 0.25
for (i in 3:G) W[i, 5*(i-2)+1:5] = 0.2
W
taiW
tail(W)
next_alpha = function(alpha) {
mu = as.vector( exp( std + B %*% alpha))
M  = as.vector( W %*% mu)
Dhat = N * M
X = W %*% diag(mu) %*% B
A = diag(N/M)
y = (D-Dhat)/N + X %*% alpha
updated_alpha = solve( t(X) %*% A %*% X + P, t(X) %*% A %*% y)
return(updated_alpha)
}
alpha = rep(0,K)
next_alpha(alpha)
mu = as.vector( exp( std + B %*% alpha))
M  = as.vector( W %*% mu)
mu
M
Dhat = N * M
Dhat
D
D = c(3889, 716, 587, 589, 791, 816, 832, 1257, 1651, 2721, 4310,
6636, 10536, 11043, 23312, 34945, 44537, 50392)
next_alpha(alpha)
i
alpha0 = rep(0,K)
alpha1 = next_alpha(alpha0)
alpha2 = next_alpha(alpha1)
alpha3 = next_alpha(alpha2)
alpha4 = next_alpha(alpha3)
alpha5 = next_alpha(alpha4)
cbind(alpha0,alpha1,alpha2,alpha3,alpha4, alpha5)
round( cbind(alpha0,alpha1,alpha2,alpha3,alpha4, alpha5), 4)
std
age
plot(age,std)
plot(age,std)
plot(age,std, type='l'
)
lines(age,std + B %*% alpha1, type='l')
lines(age,std + B %*% alpha1, type='l', col=2)
lines(age,std + B %*% alpha2, type='l', col=3)
lines(age,std + B %*% alpha3, type='l', col=4)
lines(age,std + B %*% alpha4, type='l', col=5)
lines(age,std + B %*% alpha5, type='l', col=6, lwd=4)
points(age,rate1)
points(age,rate1$logmx)
points(age,rate1$logmx[1:100],pch='+')
alpha = matrix(NA,K,6)
alpha[,1] = rep(0,K)
for (i in 2:ncol(alpha)) {
alpha[,i] = next_alpha( alpha[,i-1])
}
round( alpha, 4)
rate1
rate1$logmx[1:100]
round( rate1$logmx[1:100], 4)
dput(round( rate1$logmx[1:100], 4))
alpha[,6]
df_single  = data.frame(
age=age,
logmx_true = ITA_HMD_logmx,
logmx_fit  = std + B %*% alpha[,6]
)
ITA_HMD_logmx =
c(-4.3852, -7.1185, -7.6009, -7.7517, -8.1117, -8.1456, -8.1456,
-8.1456, -8.294, -8.2171, -8.4684, -8.294, -8.3349, -8.1456,
-8.0789, -7.9866, -7.9866, -8.0164, -7.902, -7.824, -7.7753,
-7.7753, -7.7753, -7.7753, -7.8753, -7.7063, -7.7063, -7.6628,
-7.6417, -7.8753, -7.4876, -7.4354, -7.2644, -7.3233, -7.3385,
-7.2644, -7.0021, -6.959, -6.959, -6.7855, -6.8216, -6.5713,
-6.5225, -6.4956, -6.3539, -6.2712, -6.2196, -6.0035, -5.9835,
-5.8569, -5.7992, -5.7169, -5.6694, -5.5315, -5.433, -5.3247,
-5.2514, -5.1814, -5.0625, -4.9533, -4.8783, -4.7915, -4.6767,
-4.5923, -4.4945, -4.3836, -4.2992, -4.1825, -4.0513, -3.9409,
-3.8135, -3.6913, -3.5332, -3.4455, -3.2966, -3.2069, -3.0614,
-2.9677, -2.8466, -2.7201, -2.5974, -2.4617, -2.3462, -2.2249,
-2.1253, -1.9713, -1.8905, -1.7861, -1.6842, -1.5945, -1.4583,
-1.3792, -1.297, -1.2087, -1.1393, -1.0245, -0.9444, -0.8681,
-0.7958, -0.7276)
df_single  = data.frame(
df_single  = data.frame(
age=age,
logmx_true = ITA_HMD_logmx,
logmx_fit  = std + B %*% alpha[,6]
)
df_single
data.frame(
L = L,
U = U,
N = N,
D = D
)
N = N,
data.frame(
L = L,
U = U,
N = N,
D = D
)
df_grouped = data.frame(
L = L,
U = U,
N = N,
D = D
) %>%
mutate(logmx_obs = log(D/N))
df_grouped
ggplot(data = df_single, aes(x=age,y=logmx_true)) +
geom_point()
ggplot(data = df_single, aes(x=age,y=logmx_true)) +
geom_point()
ggplot(data = df_single, aes(x=age,y=logmx_true)) +
geom_point() +
theme_bw()
df_single  = data.frame(
age=age,
std = std,
logmx_true = ITA_HMD_logmx,
logmx_fit  = std + B %*% alpha[,6]
)
ggplot(data = df_single, aes(x=age,y=logmx_true)) +
geom_point() +
geom_line(aes(x=age,y=std), color='red', alpha=.60, lwd=3) +
labs(title='Italy Females 1980')
theme_bw()
ggplot(data = df_single, aes(x=age,y=logmx_true)) +
geom_point() +
geom_line(aes(x=age,y=std), color='red', alpha=.40, lwd=3) +
labs(title='Italy Females 1980') +
theme_bw()
ggplot(data = df_single, aes(x=age,y=logmx_true)) +
geom_point() +
geom_line(aes(x=age,y=std), color='black', lwd=0.5) +
labs(title='Italy Females 1980') +
theme_bw()
ggplot(data = df_single, aes(x=age,y=logmx_true)) +
geom_point() +
geom_line(aes(x=age,y=std), color='black', lwd=0.5) +
geom_line(aes(x=age,y=logmx_fit), color='red', lwd=3, alpha=.40) +
labs(title='Italy Females 1980') +
theme_bw()
ggplot(data = df_single, aes(x=age,y=logmx_true)) +
geom_point() +
geom_line(aes(x=age,y=std), color='black', lwd=0.5) +
geom_line(aes(x=age,y=logmx_fit), color='red', lwd=3, alpha=.40) +
labs(title='Italy Females 1980',
subtitle = paste(sum(D),'deaths to',sum(N),'women')) +
theme_bw()
ggplot(data = df_single, aes(x=age,y=logmx_true)) +
geom_point() +
geom_line(aes(x=age,y=std), color='black', lwd=0.5) +
geom_line(aes(x=age,y=logmx_fit), color='red', lwd=3, alpha=.40) +
labs(title='Italy Females 1980',
subtitle = paste(sum(D),'deaths to',round(sum(N)),'women')) +
theme_bw()
ggplot(data = df_single, aes(x=age,y=logmx_true)) +
geom_point() +
geom_line(aes(x=age,y=std), color='black', lwd=0.5) +
geom_line(aes(x=age,y=logmx_fit), color='red', lwd=3, alpha=.40) +
geom_segment(data=df_grouped,aes(x=L,xend=U,
y=logmx_obs,
yend=logmx_obs)) +
labs(title='Italy Females 1980',
subtitle = paste(sum(D),'deaths to',round(sum(N)),'women')) +
theme_bw()
ggplot(data = df_single, aes(x=age,y=logmx_true)) +
geom_point() +
geom_line(aes(x=age,y=std), color='black', lwd=0.5) +
geom_line(aes(x=age,y=logmx_fit), color='red', lwd=3, alpha=.40) +
geom_segment(data=df_grouped,aes(x=L,xend=U,
y=logmx_obs,
yend=logmx_obs),
color='red',lwd=3) +
labs(title='Italy Females 1980',
subtitle = paste(sum(D),'deaths to',round(sum(N)),'women')) +
theme_bw()
ggplot(data = df_single, aes(x=age,y=logmx_true)) +
geom_point() +
geom_line(aes(x=age,y=std), color='black', lwd=0.5) +
geom_line(aes(x=age,y=logmx_fit), color='red', lwd=3, alpha=.40) +
geom_segment(data=df_grouped,aes(x=L,xend=U,
y=logmx_obs,
yend=logmx_obs),
color='red',lwd=1, alpha=.60) +
labs(title='Italy Females 1980',
subtitle = paste(sum(D),'deaths to',round(sum(N)),'women')) +
theme_bw()
ggplot(data = df_single, aes(x=age,y=logmx_true)) +
geom_point() +
geom_line(aes(x=age,y=std), color='black', lwd=0.5) +
geom_line(aes(x=age,y=logmx_fit), color='red', lwd=3, alpha=.40) +
geom_segment(data=df_grouped,aes(x=L,xend=U,
y=logmx_obs,
yend=logmx_obs),
color='royalblue',lwd=1, alpha=.70) +
labs(title='Italy Females 1980',
subtitle = paste(sum(D),'deaths to',round(sum(N)),'women')) +
theme_bw()
ggplot(data = df_single, aes(x=age,y=logmx_true)) +
geom_point() +
geom_line(aes(x=age,y=std), color='black', lwd=0.5) +
geom_line(aes(x=age,y=logmx_fit), color='red', lwd=3, alpha=.40) +
geom_segment(data=df_grouped,aes(x=L,xend=U,
y=logmx_obs,
yend=logmx_obs),
color='royalblue',lwd=1, alpha=.90) +
labs(title='Italy Females 1980',
subtitle = paste(sum(D),'deaths to',round(sum(N)),'women')) +
theme_bw()
ggplot(data = df_single, aes(x=age,y=logmx_true)) +
geom_point(size=2) +
geom_line(aes(x=age,y=std), color='black', lwd=0.5) +
geom_line(aes(x=age,y=logmx_fit), color='red', lwd=3, alpha=.40) +
geom_segment(data=df_grouped,aes(x=L,xend=U,
y=logmx_obs,
yend=logmx_obs),
color='royalblue',lwd=1, alpha=.90) +
labs(title='Italy Females 1980',
subtitle = paste(sum(D),'deaths to',round(sum(N)),'women')) +
theme_bw()
ggplot(data = df_single, aes(x=age,y=logmx_true)) +
geom_point(size=0.5) +
geom_line(aes(x=age,y=std), color='black', lwd=0.5) +
geom_line(aes(x=age,y=logmx_fit), color='red', lwd=3, alpha=.40) +
geom_segment(data=df_grouped,aes(x=L,xend=U,
y=logmx_obs,
yend=logmx_obs),
color='royalblue',lwd=1, alpha=.90) +
labs(title='Italy Females 1980',
subtitle = paste(sum(D),'deaths to',round(sum(N)),'women')) +
theme_bw()
ggplot(data = df_single, aes(x=age,y=logmx_true)) +
geom_point(size=0.5) +
geom_line(aes(x=age,y=std), color='black', lwd=0.5) +
geom_line(aes(x=age,y=logmx_fit), color='red', lwd=3, alpha=.40) +
geom_segment(data=df_grouped,aes(x=L,xend=U,
y=logmx_obs,
yend=logmx_obs),
color='red',lwd=1, alpha=.90) +
labs(title='Italy Females 1980',
subtitle = paste(sum(D),'deaths to',round(sum(N)),'women')) +
theme_bw()
ggplot(data = df_single, aes(x=age,y=logmx_true)) +
geom_line(aes(x=age,y=std), color='black', lwd=0.5) +
geom_line(aes(x=age,y=logmx_fit), color='red', lwd=3, alpha=.40) +
geom_segment(data=df_grouped,aes(x=L,xend=U,
y=logmx_obs,
yend=logmx_obs),
color='red',lwd=1, alpha=.90) +
geom_point(size=0.60) +
labs(title='Italy Females 1980',
subtitle = paste(sum(D),'deaths to',round(sum(N)),'women')) +
theme_bw()
ggplot(data = df_single, aes(x=age,y=logmx_true)) +
geom_line(aes(x=age,y=std), color='black', lwd=0.5) +
geom_line(aes(x=age,y=logmx_fit), color='red', lwd=3, alpha=.40) +
geom_segment(data=df_grouped,aes(x=L,xend=U,
y=logmx_obs,
yend=logmx_obs),
color='red',lwd=1, alpha=.90) +
geom_point(size=0.60) +
labs(title='Italy Females 1980',
subtitle = paste(sum(D),'deaths to',round(sum(N)),'women')) +
scale_x_continuous(breaks=c(L,tail(U,1))) +
theme_bw()
ggplot(data = df_single, aes(x=age,y=logmx_true)) +
geom_line(aes(x=age,y=std), color='black', lwd=0.5) +
geom_line(aes(x=age,y=logmx_fit), color='red', lwd=3, alpha=.40) +
geom_segment(data=df_grouped,aes(x=L,xend=U,
y=logmx_obs,
yend=logmx_obs),
color='red',lwd=1, alpha=.90) +
geom_point(size=0.60) +
labs(title='Italy Females 1980',
subtitle = paste(sum(D),'deaths to',round(sum(N)),'women')) +
scale_x_continuous(breaks=c(0,1,seq(5,max(U),5)) +
theme_bw()
ggplot(data = df_single, aes(x=age,y=logmx_true)) +
ggplot(data = df_single, aes(x=age,y=logmx_true)) +
geom_line(aes(x=age,y=std), color='black', lwd=0.5) +
geom_line(aes(x=age,y=logmx_fit), color='red', lwd=3, alpha=.40) +
geom_segment(data=df_grouped,aes(x=L,xend=U,
y=logmx_obs,
yend=logmx_obs),
color='red',lwd=1, alpha=.90) +
geom_point(size=0.60) +
labs(title='Italy Females 1980',
subtitle = paste(sum(D),'deaths to',round(sum(N)),'women')) +
scale_x_continuous(breaks=c(0,1,seq(5,100,5))) +
theme_bw()
ggplot(data = df_single, aes(x=age,y=logmx_true)) +
geom_line(aes(x=age,y=std), color='black', lwd=0.5) +
geom_line(aes(x=age,y=logmx_fit), color='red', lwd=3, alpha=.40) +
geom_segment(data=df_grouped,aes(x=L,xend=U,
y=logmx_obs,
yend=logmx_obs),
color='red',lwd=1, alpha=.90) +
geom_point(size=0.60) +
labs(title='Italy Females 1980',
subtitle = paste(sum(D),'deaths to',round(sum(N)),'women')) +
scale_x_continuous(breaks=c(0,1,seq(5,100,5)),minor_breaks = NULL) +
theme_bw()
bigD = D
bigN = N
target_pop = 10000
N = bigN * target_pop/sum(bigN)
D = rpois(length(N), N* log(bigD/bigN))
D
N
length(N)
target_pop = 10000
N = bigN * target_pop/sum(bigN)
D = rpois(length(N), N* bigD/bigN)
D
## save the real data in "big" versions
bigD = D
bigN = N
## simulate a small population
target_pop = 10000
N = bigN * target_pop/sum(bigN)
D = rpois(length(N), N* bigD/bigN)
## TOPALS fit with PIRLS
alpha = matrix(NA,K,6)
alpha[,1] = rep(0,K)
for (i in 2:ncol(alpha)) {
alpha[,i] = next_alpha( alpha[,i-1])
}
round( cbind(alpha0,alpha1,alpha2,alpha3,alpha4, alpha5), 4)
## save the real data in "big" versions
bigD = D
bigN = N
## simulate a small population
target_pop = 10000
N = bigN * target_pop/sum(bigN)
D = rpois(length(N), N* bigD/bigN)
## TOPALS fit with PIRLS
alpha = matrix(NA,K,6)
alpha[,1] = rep(0,K)
for (i in 2:ncol(alpha)) {
alpha[,i] = next_alpha( alpha[,i-1])
}
round( cbind(alpha0,alpha1,alpha2,alpha3,alpha4, alpha5), 4)
## plot the data, true rates, and PIRLS fit
df_grouped = data.frame(
L = L,
U = U,
N = N,
D = D
) %>%
mutate(logmx_obs = log(D/N))
df_single  = data.frame(
age=age,
std = std,
logmx_true = ITA_HMD_logmx,
logmx_fit  = std + B %*% alpha[,6]
)
ggplot(data = df_single, aes(x=age,y=logmx_true)) +
geom_line(aes(x=age,y=std), color='black', lwd=0.5) +
geom_line(aes(x=age,y=logmx_fit), color='red', lwd=3, alpha=.40) +
geom_segment(data=df_grouped,aes(x=L,xend=U,
y=logmx_obs,
yend=logmx_obs),
color='red',lwd=1, alpha=.90) +
geom_point(size=0.60) +
labs(title='Italy Females 1980',
subtitle = paste(sum(D),'deaths to',round(sum(N)),'women')) +
scale_x_continuous(breaks=c(0,1,seq(5,100,5)),minor_breaks = NULL) +
theme_bw()
B
knitr::opts_chunk$set(echo = TRUE)
## B is an Ax7 matrix. Each column is a linear B-spline basis function
B      = bs( age, knots=knot_positions, degree=1 )
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse, quietly = TRUE)
library(splines, quietly = TRUE)
## Italian female 1980 HMD data for age groups
L = c(0,1,seq(5,80,5))
U = c(tail(L,-1),85)
N = c(312106.85, 1423566.3, 2105814.63, 2249555.41, 2230885.74, 1983157.8,
1874479.58, 1989351.99, 1772133.73, 1896866.51, 1836597.36, 1834496.64,
1811178.38, 1192763.85, 1498384.03, 1223810.9, 863725.92, 537720.77)
D = c(3889, 716, 587, 589, 791, 816, 832, 1257, 1651, 2721, 4310,
6636, 10536, 11043, 23312, 34945, 44537, 50392)
## standard schedule is (arbitrarily) the 1959 period schedule
## for Canadian females at ages 0,1,...,99
## these are the log mortality rates
std = c(-3.8933, -5.7776, -6.8474, -7.3298, -7.4519, -7.4408, -7.4807,
-7.5845, -7.7219, -7.8628, -7.9771, -8.041, -8.0568, -8.0329,
-7.9779, -7.9005, -7.8088, -7.7101, -7.6113, -7.5195, -7.4415,
-7.3823, -7.3393, -7.308, -7.2837, -7.2619, -7.238, -7.2082,
-7.1712, -7.1264, -7.0735, -7.0118, -6.9414, -6.8648, -6.7849,
-6.7047, -6.6272, -6.5544, -6.4845, -6.4147, -6.3423, -6.2645,
-6.1791, -6.0872, -5.9904, -5.8903, -5.7887, -5.6869, -5.586,
-5.4866, -5.3895, -5.2953, -5.2049, -5.1186, -5.0347, -4.9513,
-4.8664, -4.778, -4.6847, -4.5877, -4.4887, -4.3895, -4.2918,
-4.1969, -4.1041, -4.0122, -3.9199, -3.8261, -3.7296, -3.6303,
-3.5278, -3.4221, -3.3129, -3.2004, -3.0861, -2.9716, -2.8589,
-2.7497, -2.6458, -2.5482, -2.4556, -2.3659, -2.2771, -2.187,
-2.0942, -1.9991, -1.9028, -1.8062, -1.7105, -1.6164, -1.5242,
-1.434, -1.3458, -1.2596, -1.1758, -1.0958, -1.0212, -0.9535,
-0.8944, -0.8454)
## single-year log mortality rates from HMD
## these are the targets for TOPALS estimation
ITA_HMD_logmx =
c(-4.3852, -7.1185, -7.6009, -7.7517, -8.1117, -8.1456, -8.1456,
-8.1456, -8.294, -8.2171, -8.4684, -8.294, -8.3349, -8.1456,
-8.0789, -7.9866, -7.9866, -8.0164, -7.902, -7.824, -7.7753,
-7.7753, -7.7753, -7.7753, -7.8753, -7.7063, -7.7063, -7.6628,
-7.6417, -7.8753, -7.4876, -7.4354, -7.2644, -7.3233, -7.3385,
-7.2644, -7.0021, -6.959, -6.959, -6.7855, -6.8216, -6.5713,
-6.5225, -6.4956, -6.3539, -6.2712, -6.2196, -6.0035, -5.9835,
-5.8569, -5.7992, -5.7169, -5.6694, -5.5315, -5.433, -5.3247,
-5.2514, -5.1814, -5.0625, -4.9533, -4.8783, -4.7915, -4.6767,
-4.5923, -4.4945, -4.3836, -4.2992, -4.1825, -4.0513, -3.9409,
-3.8135, -3.6913, -3.5332, -3.4455, -3.2966, -3.2069, -3.0614,
-2.9677, -2.8466, -2.7201, -2.5974, -2.4617, -2.3462, -2.2249,
-2.1253, -1.9713, -1.8905, -1.7861, -1.6842, -1.5945, -1.4583,
-1.3792, -1.297, -1.2087, -1.1393, -1.0245, -0.9444, -0.8681,
-0.7958, -0.7276)
## single-year ages for TOPALS schedule
age = 0:99
knot_positions = c(0,1,10,20,40,70)
## B is an Ax7 matrix. Each column is a linear B-spline basis function
B      = bs( age, knots=knot_positions, degree=1 )
K = ncol(B)
## penalty
D1 = diff( diag(K), diff=1)
P  = 2 * crossprod(D1)
## weighting matrix W
A = length(age) # number of single-year ages
G = length(L)   # number of age groups
W = matrix(0, nrow=G, ncol=A, dimnames=list(L,age))
W['0','0'] = 1
W['1',2:5] = 0.25
for (i in 3:G) W[i, 5*(i-2)+1:5] = 0.2
B
