library(tidyverse)
library(data.table)
library(splines)


#############################################################
# read Estonia 2010 HMD female life table and population
life_table = fread(
'year           age    mx       qx       ax    lx         dx    Lx     Tx       ex
2010           0      0.00246  0.00245  0.14  100000     245   99790  8055521  80.56
2010           1      0.00064  0.00064  0.50   99755      64   99723  7955730  79.75
2010           2      0.00026  0.00026  0.50   99691      26   99678  7856008  78.80
2010           3      0.00014  0.00014  0.50   99665      14   99658  7756330  77.82
2010           4      0.00014  0.00014  0.50   99651      14   99644  7656672  76.83
2010           5      0.00059  0.00059  0.50   99637      59   99607  7557028  75.85
2010           6      0.00031  0.00031  0.50   99578      31   99563  7457420  74.89
2010           7      0.00016  0.00016  0.50   99547      16   99539  7357858  73.91
2010           8      0.00000  0.00000  0.50   99531       0   99531  7258318  72.92
2010           9      0.00000  0.00000  0.50   99531       0   99531  7158787  71.92
2010          10      0.00034  0.00034  0.50   99531      33   99515  7059255  70.92
2010          11      0.00000  0.00000  0.50   99498       0   99498  6959741  69.95
2010          12      0.00018  0.00018  0.50   99498      18   99489  6860243  68.95
2010          13      0.00000  0.00000  0.50   99480       0   99480  6760754  67.96
2010          14      0.00016  0.00016  0.50   99480      16   99472  6661273  66.96
2010          15      0.00047  0.00047  0.50   99464      47   99441  6561801  65.97
2010          16      0.00015  0.00015  0.50   99417      15   99410  6462360  65.00
2010          17      0.00013  0.00013  0.50   99402      13   99395  6362951  64.01
2010          18      0.00000  0.00000  0.50   99389       0   99389  6263556  63.02
2010          19      0.00023  0.00023  0.50   99389      23   99377  6164167  62.02
2010          20      0.00021  0.00021  0.50   99366      21   99355  6064790  61.03
2010          21      0.00020  0.00020  0.50   99345      20   99335  5965434  60.05
2010          22      0.00010  0.00010  0.50   99325      10   99320  5866099  59.06
2010          23      0.00021  0.00021  0.50   99315      20   99305  5766779  58.07
2010          24      0.00053  0.00053  0.50   99295      53   99268  5667474  57.08
2010          25      0.00073  0.00073  0.50   99242      73   99206  5568206  56.11
2010          26      0.00021  0.00021  0.50   99169      21   99159  5469000  55.15
2010          27      0.00085  0.00085  0.50   99148      85   99106  5369841  54.16
2010          28      0.00033  0.00033  0.50   99064      32   99048  5270735  53.21
2010          29      0.00033  0.00033  0.50   99031      33   99015  5171688  52.22
2010          30      0.00045  0.00045  0.50   98998      45   98976  5072673  51.24
2010          31      0.00079  0.00079  0.50   98954      78   98915  4973696  50.26
2010          32      0.00034  0.00034  0.50   98876      33   98859  4874781  49.30
2010          33      0.00045  0.00044  0.50   98842      44   98820  4775922  48.32
2010          34      0.00077  0.00077  0.50   98798      76   98760  4677102  47.34
2010          35      0.00066  0.00066  0.50   98722      65   98689  4578342  46.38
2010          36      0.00077  0.00077  0.50   98657      76   98619  4479652  45.41
2010          37      0.00099  0.00099  0.50   98581      97   98532  4381033  44.44
2010          38      0.00074  0.00074  0.50   98483      73   98447  4282502  43.48
2010          39      0.00096  0.00096  0.50   98410      94   98363  4184055  42.52
2010          40      0.00127  0.00127  0.50   98316     125   98254  4085692  41.56
2010          41      0.00099  0.00099  0.50   98191      98   98142  3987439  40.61
2010          42      0.00103  0.00103  0.50   98093     101   98043  3889296  39.65
2010          43      0.00070  0.00070  0.50   97992      69   97958  3791254  38.69
2010          44      0.00220  0.00220  0.50   97923     215   97816  3693296  37.72
2010          45      0.00177  0.00177  0.50   97708     173   97622  3595480  36.80
2010          46      0.00263  0.00262  0.50   97535     256   97407  3497859  35.86
2010          47      0.00247  0.00247  0.50   97279     240   97159  3400451  34.96
2010          48      0.00171  0.00171  0.50   97039     166   96956  3303292  34.04
2010          49      0.00189  0.00189  0.50   96873     183   96782  3206336  33.10
2010          50      0.00408  0.00407  0.50   96690     394   96493  3109554  32.16
2010          51      0.00297  0.00297  0.50   96297     286   96154  3013061  31.29
2010          52      0.00326  0.00326  0.50   96011     313   95854  2916907  30.38
2010          53      0.00285  0.00285  0.50   95698     273   95562  2821053  29.48
2010          54      0.00402  0.00401  0.50   95425     383   95234  2725491  28.56
2010          55      0.00441  0.00440  0.50   95043     419   94834  2630257  27.67
2010          56      0.00584  0.00582  0.50   94624     551   94349  2535423  26.79
2010          57      0.00485  0.00483  0.50   94073     455   93846  2441074  25.95
2010          58      0.00475  0.00474  0.50   93619     444   93397  2347228  25.07
2010          59      0.00484  0.00483  0.50   93175     450   92950  2253832  24.19
2010          60      0.00740  0.00737  0.50   92725     683   92383  2160882  23.30
2010          61      0.00782  0.00779  0.50   92042     717   91683  2068498  22.47
2010          62      0.00777  0.00774  0.50   91325     707   90971  1976815  21.65
2010          63      0.01002  0.00997  0.50   90618     904   90166  1885844  20.81
2010          64      0.01080  0.01074  0.50   89714     964   89232  1795679  20.02
2010          65      0.01277  0.01268  0.50   88750    1126   88187  1706447  19.23
2010          66      0.01026  0.01021  0.50   87624     894   87177  1618260  18.47
2010          67      0.01350  0.01341  0.50   86730    1163   86149  1531082  17.65
2010          68      0.01316  0.01308  0.50   85567    1119   85008  1444934  16.89
2010          69      0.01467  0.01456  0.50   84448    1230   83833  1359926  16.10
2010          70      0.01353  0.01344  0.50   83218    1119   82659  1276093  15.33
2010          71      0.01839  0.01822  0.50   82099    1496   81352  1193434  14.54
2010          72      0.02011  0.01991  0.50   80604    1605   79801  1112083  13.80
2010          73      0.02176  0.02153  0.50   78999    1701   78148  1032282  13.07
2010          74      0.02507  0.02476  0.50   77298    1914   76341   954134  12.34
2010          75      0.02801  0.02762  0.50   75384    2082   74343   877793  11.64
2010          76      0.03008  0.02963  0.50   73302    2172   72216   803450  10.96
2010          77      0.03849  0.03776  0.50   71130    2686   69787   731234  10.28
2010          78      0.04071  0.03989  0.50   68444    2730   67079   661447   9.66
2010          79      0.05160  0.05030  0.50   65713    3306   64061   594368   9.04
2010          80      0.05487  0.05341  0.50   62408    3333   60741   530307   8.50
2010          81      0.06088  0.05908  0.50   59075    3490   57330   469566   7.95
2010          82      0.06675  0.06459  0.50   55585    3590   53789   412236   7.42
2010          83      0.07599  0.07321  0.50   51994    3806   50091   358447   6.89
2010          84      0.08657  0.08298  0.50   48188    3999   46188   308356   6.40
2010          85      0.09597  0.09158  0.50   44189    4047   42166   262167   5.93
2010          86      0.12556  0.11814  0.50   40142    4743   37771   220002   5.48
2010          87      0.11733  0.11083  0.50   35400    3923   33438   182230   5.15
2010          88      0.14262  0.13313  0.50   31476    4190   29381   148792   4.73
2010          89      0.16010  0.14823  0.50   27286    4045   25264   119411   4.38
2010          90      0.17928  0.16453  0.50   23241    3824   21330    94147   4.05
2010          91      0.20020  0.18198  0.50   19418    3534   17651    72818   3.75
2010          92      0.22290  0.20055  0.50   15884    3186   14291    55167   3.47
2010          93      0.24739  0.22015  0.50   12698    2796   11301    40876   3.22
2010          94      0.27361  0.24068  0.50    9903    2383    8711    29575   2.99
2010          95      0.30150  0.26200  0.50    7519    1970    6534    20864   2.77
2010          96      0.33094  0.28395  0.50    5549    1576    4761    14330   2.58
2010          97      0.36176  0.30635  0.50    3973    1217    3365     9569   2.41
2010          98      0.39377  0.32900  0.50    2756     907    2303     6204   2.25
2010          99      0.42671  0.35168  0.50    1849     650    1524     3901   2.11
2010         100      0.46032  0.37420  0.50    1199     449     975     2377   1.98
2010         101      0.49429  0.39634  0.50     750     297     602     1402   1.87
2010         102      0.52832  0.41792  0.50     453     189     358      800   1.77
2010         103      0.56208  0.43877  0.50     264     116     206      442   1.68
2010         104      0.59528  0.45874  0.50     148      68     114      236   1.60
2010         105      0.62763  0.47772  0.50      80      38      61      122   1.52
2010         106      0.65887  0.49560  0.50      42      21      31       61   1.46
2010         107      0.68880  0.51235  0.50      21      11      16       30   1.41
2010         108      0.71722  0.52791  0.50      10       5       8       14   1.36
2010         109      0.74402  0.54228  0.50       5       3       4        6   1.32
2010         110     0.76909  1.00000  1.30       2       2       3        3   1.30')

pop = fread(
'   year           age            female          male           total
    2010           0              7760.00         8020.00        15780.00
    2010           1              7760.00         8240.00        16000.00
    2010           2              7650.00         8030.00        15680.00
    2010           3              7100.00         7700.00        14800.00
    2010           4              6800.00         7380.00        14180.00
    2010           5              6710.00         7050.00        13760.00
    2010           6              6350.00         6510.00        12860.00
    2010           7              6250.00         6470.00        12720.00
    2010           8              5960.00         6380.00        12340.00
    2010           9              6070.00         6630.00        12700.00
    2010          10              5800.00         6110.00        11910.00
    2010          11              5630.00         6010.00        11640.00
    2010          12              5750.00         6190.00        11940.00
    2010          13              6150.00         6470.00        12620.00
    2010          14              6210.00         6490.00        12700.00
    2010          15              6510.00         6660.00        13170.00
    2010          16              6820.00         7340.00        14160.00
    2010          17              7970.00         8430.00        16400.00
    2010          18              8230.00         8690.00        16920.00
    2010          19              9210.00         9890.00        19100.00
    2010          20              9880.00        10570.00        20450.00
    2010          21             10060.00        10660.00        20720.00
    2010          22              9890.00        10620.00        20510.00
    2010          23              9500.00        10120.00        19620.00
    2010          24              9450.00         9960.00        19410.00
    2010          25              9680.00        10040.00        19720.00
    2010          26              9520.00        10170.00        19690.00
    2010          27              9260.00         9570.00        18830.00
    2010          28              9090.00         9740.00        18830.00
    2010          29              9030.00         9520.00        18550.00
    2010          30              8900.00         9430.00        18330.00
    2010          31              8890.00         9320.00        18210.00
    2010          32              8990.00         9630.00        18620.00
    2010          33              9150.00         9480.00        18630.00
    2010          34              8990.00         9510.00        18500.00
    2010          35              9190.00         9310.00        18500.00
    2010          36              8980.00         9460.00        18440.00
    2010          37              9350.00         9600.00        18950.00
    2010          38              9500.00         9750.00        19250.00
    2010          39              9480.00         9420.00        18900.00
    2010          40              9280.00         9230.00        18510.00
    2010          41              8890.00         8880.00        17770.00
    2010          42              8590.00         8260.00        16850.00
    2010          43              8580.00         8390.00        16970.00
    2010          44              8880.00         8380.00        17260.00
    2010          45              9190.00         8870.00        18060.00
    2010          46              9150.00         8810.00        17960.00
    2010          47              9640.00         9190.00        18830.00
    2010          48             10150.00         9250.00        19400.00
    2010          49             10180.00         9240.00        19420.00
    2010          50             10000.00         9140.00        19140.00
    2010          51              9830.00         8830.00        18660.00
    2010          52              9870.00         8670.00        18540.00
    2010          53              9840.00         8390.00        18230.00
    2010          54             10120.00         8610.00        18730.00
    2010          55              9900.00         8270.00        18170.00
    2010          56              9370.00         7860.00        17230.00
    2010          57              9680.00         7840.00        17520.00
    2010          58              9740.00         7640.00        17380.00
    2010          59              9330.00         7300.00        16630.00
    2010          60              9930.00         7620.00        17550.00
    2010          61              9320.00         7030.00        16350.00
    2010          62              9020.00         6700.00        15720.00
    2010          63              8430.00         6000.00        14430.00
    2010          64              6690.00         4800.00        11490.00
    2010          65              6720.00         4660.00        11380.00
    2010          66              6430.00         4450.00        10880.00
    2010          67              7890.00         5260.00        13150.00
    2010          68              9380.00         5920.00        15300.00
    2010          69              8330.00         5180.00        13510.00
    2010          70              8930.00         5220.00        14150.00
    2010          71              8730.00         5010.00        13740.00
    2010          72              8950.00         4860.00        13810.00
    2010          73              7880.00         4300.00        12180.00
    2010          74              7330.00         3810.00        11140.00
    2010          75              6580.00         3220.00         9800.00
    2010          76              6460.00         3190.00         9650.00
    2010          77              7030.00         3200.00        10230.00
    2010          78              6670.00         3000.00         9670.00
    2010          79              6310.00         2780.00         9090.00
    2010          80              5682.20         2331.59         8013.79
    2010          81              5732.70         2244.65         7977.35
    2010          82              4976.31         1971.06         6947.37
    2010          83              4734.64         1423.67         6158.31
    2010          84              3974.88         1089.95         5064.83
    2010          85              3545.72          921.45         4467.17
    2010          86              3148.83          743.76         3892.59
    2010          87              2525.24          604.70         3129.94
    2010          88              2092.07          474.05         2566.12
    2010          89              1310.56          326.62         1637.18
    2010          90               992.04          239.24         1231.28
    2010          91               860.19          175.41         1035.60
    2010          92               538.23          109.09          647.32
    2010          93               430.48           80.98          511.46
    2010          94               372.05           87.20          459.25
    2010          95               315.08           79.14          394.22
    2010          96               255.36           44.54          299.90
    2010          97               150.36           35.33          185.69
    2010          98                98.43           15.25          113.68
    2010          99                73.74           10.76           84.50
    2010         100                38.43            9.98           48.41
    2010         101                25.04            4.66           29.70
    2010         102                14.15            3.62           17.77
    2010         103                 8.58            2.04           10.62
    2010         104                 5.14            0.80            5.94
    2010         105                 2.36            0.69            3.05
    2010         106                 0.86            0.00            0.86
    2010         107                 0.28            0.00            0.28
    2010         108                 0.00            0.00            0.00
    2010         109                 0.00            0.00            0.00
    2010         110                0.00            0.00            0.00'    )

EST = full_join(pop, life_table, by=c('year','age')) %>%
        filter(age < 100)

#############################################################
# rather arbitrary: US 2015 female rates are the std
this.std = log(
c(0.00539, 0.00035, 0.00023, 0.00016, 0.00013, 
  0.00011, 0.00012, 0.0001,  0.0001,  0.00008, 
  0.00008, 0.0001,  0.00011, 0.00015, 0.00017, 
  0.00018, 0.00024, 0.00028, 0.00036, 0.0004, 
  0.00041, 0.00046, 0.00046, 0.00048, 0.00051, 
  0.00056, 0.00056, 0.00061, 0.00064, 0.00068, 
  0.00074, 0.00077, 0.00086, 0.00089, 0.00092, 
  0.00096, 0.00108, 0.0011,  0.00119, 0.00119, 
  0.00131, 0.00145, 0.00159, 0.00169, 0.00187, 
  0.00202, 0.0022,  0.00238, 0.00267, 0.00288, 
  0.00319, 0.00347, 0.00383, 0.00415, 0.00443, 
  0.00476, 0.00521, 0.00561, 0.00602, 0.00633, 
  0.00669, 0.00724, 0.00789, 0.00849, 0.00901, 
  0.0097,  0.01057, 0.01163, 0.01254, 0.01395, 
  0.01527, 0.01698, 0.01895, 0.02053, 0.02209, 
  0.02478, 0.02713, 0.03045, 0.03332, 0.0375, 
  0.04202, 0.046,   0.05244, 0.05853, 0.06517, 
  0.07324, 0.08133, 0.09339, 0.10453, 0.11452, 
  0.12893, 0.14443, 0.16185, 0.18276, 0.20084, 
  0.22288, 0.24582, 0.27031, 0.29627, 0.32362))
  

### TOPALS building blocks
### B-spline matrix (101 x 7)
age    = 0:99
B      = bs( age, knots=c(0,1,10,20,40,70), degree=1)
nalpha = ncol(B)

### log likelihood function L(alpha | D,N)
penalized.logL = function( alpha, D, N, std, Basis=B, k=1) {
  logmx.hat = std + (Basis %*% alpha)
  penalty = k * sum(diff(alpha)^2)
  return( sum( -N * exp(logmx.hat) + D * logmx.hat) - penalty)
}

## standardized control parameters for all nonlinear fits
this.control = list(maxit=1000,fnscale= -1, parscale=rep(.01,ncol(B)))

alpha0 = rep(0, nalpha)  # initial offsets (all 0 means start at standard schedule)


########################
# trapez approx of life expectancy from a logmx schedule over ages 0..99
e0 = function(logmx) {
  mx = exp(logmx)
  px = exp(-mx)
  lx = c(1,cumprod(px))
  return( sum(head(lx,-1) + tail(lx,-1)) / 2)
}

#############################################################

pop_size = 5e3

ntrial = 1

  this.pop = pop_size
  
  print(this.pop)
  
      this.N = rmultinom(n=ntrial, size=this.pop, prob=EST$female)
       
      this.D = matrix( rpois(100*ntrial, lambda=this.N * EST$mx),
                       nrow=100)

      ## par will be nalpha x ntrial
      par = sapply(1:ntrial, function(j) {
                     optim( alpha0, penalized.logL,
                                 D=this.D[,j], N=this.N[,j],
                                 std=this.std, Basis=B,
                                 method='BFGS', control=this.control)$par })

      lambda.hat = this.std + B %*% par
      
      tmp = this.N * exp(lambda.hat)
      

#######################
## iterative Newton-Raphson
      
Dhat = function(alpha) {
  lambda.hat = this.std + B %*% alpha
  return(  as.numeric( this.N * exp(lambda.hat) ))
}      
      
Diff = matrix(0,6,7) 
diag(Diff[,1:6]) = -1
diag(Diff[,2:7]) = +1
DD = crossprod(Diff)
      
next_alpha = function(alpha) {
  this.dhat = Dhat(alpha)
  M = solve ( t(B) %*% diag(this.dhat) %*% B + 2*DD)
  v = t(B) %*% (this.D - this.dhat) - 2* (DD %*% alpha)
  return( alpha + M %*% v)
}
      
a = matrix(0,7,20)

for (j in 2:20) {
  a[,j] = next_alpha(a[,j-1])
}

logP = apply(a, 2, penalized.logL, N=this.N, D=this.D,
                     std=this.std)

plot(logP)

data.frame(iter.a=a[,ncol(a)], optim.a=par)


Q.iter  = penalized.logL(a[,ncol(a)], N=this.N, D=this.D, std=this.std)
Q.optim = penalized.logL(par, N=this.N, D=this.D, std=this.std)

list( 
  Q.iter   = Q.iter,
  Q.optim  = Q.optim,
  e0.iter  = e0( this.std + B %*% a[,ncol(a)]),
  e0.optim = e0( this.std + B %*% par)
)

plot(logP, type='o')
abline( h=Q.optim, col='red')

plot(tail(logP,-3), type='o')
abline( h=Q.optim, col='red')

matplot(t(a), type='o')
points( rep(ncol(a),7), par, pch=16, col=1:6, cex=1.5)

age = 0:99
plot( age, log( this.D / this.N), ylim=c(-10,0))
lines(age, this.std, lty=2, col='grey', lwd=3)
lines(age, this.std + B %*% par, lty=2, col='red', lwd=3)
lines(age, this.std + B %*% a[,ncol(a)], lty=2, col='purple', lwd=3)
